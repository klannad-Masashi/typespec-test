<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共通model編集 - TypeSpec Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>共通model編集</h1>
                    <div>
                        <a href="/common-models" class="btn btn-outline-secondary me-2">← 一覧に戻る</a>
                        <a href="/" class="btn btn-outline-secondary">← トップに戻る</a>
                    </div>
                </div>

                <form id="editCommonModelForm">
                    <!-- 共通モデル編集 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>共通model編集</h5>
                        </div>
                        <div class="card-body">
                            <div id="common-models-container">
                                <!-- モデルデータがここにロードされる -->
                            </div>
                            <div id="loading-message" class="text-muted text-center py-4">
                                データを読み込み中...
                            </div>
                        </div>
                    </div>

                    <!-- 送信ボタン -->
                    <div class="d-grid gap-2 mb-4" id="submit-section" style="display: none;">
                        <button type="submit" class="btn btn-primary btn-lg">更新</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 共通モデルテンプレート -->
    <template id="common-model-template">
        <div class="common-model-item border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">共通model #<span class="common-model-number"></span></h6>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="addCommonField(this)">+ フィールド追加</button>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">モデル名 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control common-model-name" placeholder="例: BaseUser, CommonAddress" required>
                    <div class="form-text">他のAPIから参照する際の名前になります</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">説明</label>
                    <input type="text" class="form-control common-model-description" placeholder="このモデルの説明">
                </div>
            </div>

            <div class="common-fields-section">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">フィールド定義</label>
                </div>
                <div class="common-fields-container">
                    <!-- フィールドがここに動的追加される -->
                </div>
            </div>
        </div>
    </template>

    <!-- 共通フィールドテンプレート -->
    <template id="common-field-template">
        <div class="common-field-item row mb-2 p-2 border rounded">
            <div class="col-md-3">
                <input type="text" class="form-control common-field-name" placeholder="フィールド名" required>
            </div>
            <div class="col-md-2">
                <select class="form-select common-field-type">
                    <option value="string">String</option>
                    <option value="integer">Integer</option>
                    <option value="number">Number</option>
                    <option value="boolean">Boolean</option>
                    <option value="date">Date</option>
                    <option value="datetime">DateTime</option>
                    <option value="email">Email</option>
                    <option value="url">URL</option>
                    <option value="uuid">UUID</option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-check">
                    <input class="form-check-input common-field-required" type="checkbox" checked>
                    <label class="form-check-label">必須</label>
                </div>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control common-field-description" placeholder="説明">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeCommonField(this)">削除</button>
            </div>
            
            <!-- 制限入力欄 -->
            <div class="col-12 mt-2 common-field-constraints" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label text-muted small common-constraint-min-label">最小値</label>
                        <input type="number" class="form-control form-control-sm common-field-min-value" placeholder="最小値">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small common-constraint-max-label">最大値</label>
                        <input type="number" class="form-control form-control-sm common-field-max-value" placeholder="最大値">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- 処理結果モーダル -->
    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalTitle">処理結果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="resultContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // モデルIDを取得
        const modelId = {{ model_id }};
        let commonModelCounter = 0;
        
        // ページ読み込み時にモデルデータを取得
        document.addEventListener('DOMContentLoaded', function() {
            loadModelData();
        });
        
        // モデルデータを読み込み
        async function loadModelData() {
            try {
                const response = await fetch(`/api/common-models/${modelId}`);
                const result = await response.json();
                
                if (result.success) {
                    populateModelData(result.model);
                } else {
                    document.getElementById('loading-message').innerHTML = 
                        '<div class="text-danger text-center py-3">モデルの読み込みに失敗しました。</div>';
                }
            } catch (error) {
                console.error('Failed to load model data:', error);
                document.getElementById('loading-message').innerHTML = 
                    '<div class="text-danger text-center py-3">データの読み込み中にエラーが発生しました。</div>';
            }
        }
        
        // モデルデータを画面に設定
        function populateModelData(model) {
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('submit-section').style.display = '';
            
            // モデル1つを追加
            addCommonModel();
            
            const modelItem = document.querySelector('.common-model-item');
            modelItem.querySelector('.common-model-name').value = model.name;
            modelItem.querySelector('.common-model-description').value = model.description || '';
            
            // フィールドを設定
            model.fields.forEach(fieldData => {
                addCommonField(modelItem.querySelector('.btn-outline-success'));
                
                const fieldsContainer = modelItem.querySelector('.common-fields-container');
                const lastField = fieldsContainer.lastElementChild;
                
                lastField.querySelector('.common-field-name').value = fieldData.name;
                
                // フィールドタイプを設定
                const typeSelect = lastField.querySelector('.common-field-type');
                typeSelect.value = fieldData.type;
                
                // フィールドタイプ変更イベントリスナーを追加
                typeSelect.addEventListener('change', function() {
                    toggleCommonFieldConstraints(this);
                });
                
                lastField.querySelector('.common-field-required').checked = fieldData.required;
                lastField.querySelector('.common-field-description').value = fieldData.description || '';
                
                // バリデーションを設定
                const validations = fieldData.validations || {};
                if (validations.minimum || validations.maximum) {
                    lastField.querySelector('.common-field-min-value').value = validations.minimum || '';
                    lastField.querySelector('.common-field-max-value').value = validations.maximum || '';
                } else if (validations.minLength || validations.maxLength) {
                    lastField.querySelector('.common-field-min-value').value = validations.minLength || '';
                    lastField.querySelector('.common-field-max-value').value = validations.maxLength || '';
                }
                
                // フィールドタイプに応じて制約を表示
                toggleCommonFieldConstraints(typeSelect);
            });
        }
        
        // フィールドタイプに応じて制約入力欄の表示/非表示を切り替え
        function toggleCommonFieldConstraints(selectElement) {
            const fieldItem = selectElement.closest('.common-field-item');
            const constraintsDiv = fieldItem.querySelector('.common-field-constraints');
            const minLabel = fieldItem.querySelector('.common-constraint-min-label');
            const maxLabel = fieldItem.querySelector('.common-constraint-max-label');
            const minInput = fieldItem.querySelector('.common-field-min-value');
            const maxInput = fieldItem.querySelector('.common-field-max-value');
            
            const fieldType = selectElement.value;
            
            if (fieldType === 'integer' || fieldType === 'number') {
                constraintsDiv.style.display = 'block';
                minLabel.textContent = '最小値';
                maxLabel.textContent = '最大値';
                minInput.type = 'number';
                maxInput.type = 'number';
                minInput.placeholder = '最小値';
                maxInput.placeholder = '最大値';
            } else if (fieldType === 'string' || fieldType === 'text' || fieldType === 'email' || fieldType === 'url') {
                constraintsDiv.style.display = 'block';
                minLabel.textContent = '最小文字数';
                maxLabel.textContent = '最大文字数';
                minInput.type = 'number';
                maxInput.type = 'number';
                minInput.placeholder = '最小文字数';
                maxInput.placeholder = '最大文字数';
            } else {
                constraintsDiv.style.display = 'none';
            }
        }
        
        // 共通フィールドを追加
        function addCommonField(button) {
            const template = document.getElementById('common-field-template');
            const clone = template.content.cloneNode(true);
            
            // フィールドタイプ変更イベントを追加
            const typeSelect = clone.querySelector('.common-field-type');
            typeSelect.addEventListener('change', function() {
                toggleCommonFieldConstraints(this);
            });
            
            // モデルのフィールドコンテナに追加
            const modelItem = button.closest('.common-model-item');
            const fieldsContainer = modelItem.querySelector('.common-fields-container');
            fieldsContainer.appendChild(clone);
        }
        
        // 共通フィールドを削除
        function removeCommonField(button) {
            const fieldItem = button.closest('.common-field-item');
            fieldItem.remove();
        }
        
        // 新しい共通モデルを追加
        function addCommonModel() {
            commonModelCounter++;
            
            const template = document.getElementById('common-model-template');
            const clone = template.content.cloneNode(true);
            
            // モデル番号を設定
            clone.querySelector('.common-model-number').textContent = commonModelCounter;
            
            // コンテナに追加
            const container = document.getElementById('common-models-container');
            container.appendChild(clone);
            
            // フィールドタイプ変更イベントを追加
            const modelItem = container.lastElementChild;
            const typeSelects = modelItem.querySelectorAll('.common-field-type');
            typeSelects.forEach(select => {
                select.addEventListener('change', function() {
                    toggleCommonFieldConstraints(this);
                });
            });
        }
        
        // フォーム送信処理
        document.getElementById('editCommonModelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const modelItems = document.querySelectorAll('.common-model-item');
            let modelData = null;
            
            modelItems.forEach(item => {
                const name = item.querySelector('.common-model-name').value.trim();
                const description = item.querySelector('.common-model-description').value.trim();
                
                if (!name) {
                    alert('モデル名は必須です');
                    return;
                }
                
                const fields = [];
                const fieldItems = item.querySelectorAll('.common-field-item');
                
                fieldItems.forEach(fieldItem => {
                    const fieldName = fieldItem.querySelector('.common-field-name').value.trim();
                    const fieldType = fieldItem.querySelector('.common-field-type').value;
                    const fieldRequired = fieldItem.querySelector('.common-field-required').checked;
                    const fieldDescription = fieldItem.querySelector('.common-field-description').value.trim();
                    const minValue = fieldItem.querySelector('.common-field-min-value').value;
                    const maxValue = fieldItem.querySelector('.common-field-max-value').value;
                    
                    if (!fieldName) return;
                    
                    const validations = {};
                    
                    if (fieldType === 'integer' || fieldType === 'number') {
                        if (minValue) validations.minimum = parseFloat(minValue);
                        if (maxValue) validations.maximum = parseFloat(maxValue);
                    } else if (fieldType === 'string' || fieldType === 'text' || fieldType === 'email' || fieldType === 'url') {
                        if (minValue) validations.minLength = parseInt(minValue);
                        if (maxValue) validations.maxLength = parseInt(maxValue);
                    }
                    
                    fields.push({
                        name: fieldName,
                        type: fieldType,
                        required: fieldRequired,
                        description: fieldDescription,
                        validations: validations
                    });
                });
                
                modelData = {
                    name: name,
                    description: description,
                    fields: fields
                };
            });
            
            if (!modelData) {
                alert('モデルデータを入力してください');
                return;
            }
            
            // 更新APIを呼び出し
            try {
                const response = await fetch(`/api/common-models/${modelId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(modelData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResultModal('成功', `
                        <div class="alert alert-success">
                            <h6>共通modelの更新が完了しました！</h6>
                            <p>${result.message}</p>
                        </div>
                    `, true);
                    
                    // 成功後は一覧に戻る
                    setTimeout(() => {
                        window.location.href = '/common-models';
                    }, 2000);
                } else {
                    showResultModal('エラー', `
                        <div class="alert alert-danger">
                            <h6>共通modelの更新に失敗しました</h6>
                            <p>${result.error}</p>
                        </div>
                    `, false);
                }
            } catch (error) {
                console.error('Update error:', error);
                showResultModal('エラー', `
                    <div class="alert alert-danger">
                        <h6>通信エラーが発生しました</h6>
                        <p>${error.message}</p>
                    </div>
                `, false);
            }
        });
        
        // 結果モーダルを表示
        function showResultModal(title, content, success) {
            document.getElementById('resultModalTitle').textContent = title;
            document.getElementById('resultContent').innerHTML = content;
            
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }
    </script>
</body>
</html>